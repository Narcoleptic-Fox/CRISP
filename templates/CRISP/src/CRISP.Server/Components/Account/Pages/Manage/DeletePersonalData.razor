@page "/Account/Manage/DeletePersonalData"

@using System.ComponentModel.DataAnnotations
@using CRISP.Server.Components.Account
@using CRISP.Server.Data
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<DeletePersonalData> Logger

<PageTitle>Delete Personal Data</PageTitle>

<div class="space-y-6">
    <div>
        <h2 class="text-lg font-medium text-foreground">Delete account</h2>
        <p class="text-sm text-muted-foreground">Permanently delete your account and all associated data.</p>
    </div>
    
    <StatusMessage Message="@message" />
    
    <div class="rounded-lg border border-destructive/50 bg-destructive/10 p-4">
        <div class="flex">
            <svg class="h-5 w-5 text-destructive" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="ml-3">
                <p class="text-sm font-medium text-destructive">
                    This action cannot be undone
                </p>
                <p class="mt-1 text-sm text-destructive/80">
                    Deleting your account will permanently remove all your data, including your profile, settings, and any content you've created.
                </p>
            </div>
        </div>
    </div>
    
    <EditForm Model="Input" FormName="delete-user" OnValidSubmit="OnValidSubmitAsync" method="post" class="space-y-6">
        <DataAnnotationsValidator />
        <ValidationSummary class="text-sm text-destructive" role="alert" />
        
        @if (requirePassword)
        {
            <div>
                <label for="Input.Password" class="block text-sm font-medium text-foreground">
                    Confirm your password
                </label>
                <div class="mt-1">
                    <InputText type="password" @bind-Value="Input.Password" id="Input.Password"
                        class="block w-full rounded-md border border-input bg-background px-3 py-2 text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
                        autocomplete="current-password"
                        placeholder="••••••••" />
                </div>
                <ValidationMessage For="() => Input.Password" class="mt-1 text-sm text-destructive" />
            </div>
        }

        <div class="flex">
            <button type="submit"
                class="inline-flex items-center justify-center rounded-md bg-destructive px-4 py-2 text-sm font-medium text-destructive-foreground hover:bg-destructive/90 transition-colors">
                <svg class="mr-2 h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
                Delete my account
            </button>
        </div>
    </EditForm>
</div>

@code {
    private string? message;
    private ApplicationUser user = default!;
    private bool requirePassword;

    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        Input ??= new();
        user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        requirePassword = await UserManager.HasPasswordAsync(user);
    }

    private async Task OnValidSubmitAsync()
    {
        if (requirePassword && !await UserManager.CheckPasswordAsync(user, Input.Password))
        {
            message = "Error: Incorrect password.";
            return;
        }

        var result = await UserManager.DeleteAsync(user);
        if (!result.Succeeded)
        {
            throw new InvalidOperationException("Unexpected error occurred deleting user.");
        }

        await SignInManager.SignOutAsync();

        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' deleted themselves.", userId);

        RedirectManager.RedirectToCurrentPage();
    }

    private sealed class InputModel
    {
        [DataType(DataType.Password)]
        public string Password { get; set; } = "";
    }
}
