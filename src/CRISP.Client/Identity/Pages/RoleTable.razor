@page "/admin/roles"
@inherits BaseCrudTableComponent<Roles, RoleTableState,GetRoles, AddRoleDialog, CreateRole, IRoleService>

<MudDataGrid @ref="dataGrid" T="Roles" ServerData="ServerData"
             FixedHeader FixedFooter Virtualize Hover
             Filterable FilterMode="DataGridFilterMode.ColumnFilterRow" FilterCaseSensitivity="DataGridFilterCaseSensitivity.CaseInsensitive"
             SortMode="SortMode.Single">
    <ToolBarContent>
        <MudStack Row="true" Justify="Justify.FlexStart" Style="width:100%">
            <MudText Typo="Typo.h6">@nameof(Users)</MudText>
            <MudSpacer />
            @if (AuthState.HasPermission(Permissions.CanCreateRole))
            {
                <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Primary"
                               OnClick="Add" />
            }
        </MudStack>
    </ToolBarContent>
    <Columns>
        @if (AuthState is not null)
        {
            <TemplateColumn Filterable="false" Sortable="false">
                <CellTemplate>
                    <MudMenu Icon="@Icons.Material.Rounded.MoreVert" Size="@Size.Small">
                        @if (AuthState.HasPermissions(Permissions.CanDeleteRole))
                        {
                            <MudMenuItem OnClick="@(_ => Remove(context.Item))">Delete</MudMenuItem>
                        }
                    </MudMenu>
                </CellTemplate>
            </TemplateColumn>
        }
        <PropertyColumn Property="m => m.Name" Title="@nameof(Roles.Name).Titleize()" />
        <PropertyColumn Property="m => m.Permissions" Title="@nameof(Roles.Permissions).Titleize()" />
    </Columns>
</MudDataGrid>

@code {
    [CascadingParameter]
    public AuthenticationState? AuthState { get; set; }

    protected override async Task<GridData<Roles>> ServerData(GridState<Roles> state)
    {
        var sortDefinition = state.SortDefinitions.FirstOrDefault();
        var query = new GetRoles
        {
            Page = state.Page,
            PageSize = state.PageSize,
            SortBy = sortDefinition?.SortBy,
            SortDescending = sortDefinition?.Descending,
            Names = State.Names,
            Permissions = State.Permissions,
        };

        var result = await ModelService.Send(query);
        return new()
        {
            Items = result.Items,
            TotalItems = result.TotalCount
        };
    }
}