@page "/Account/Manage/ResetAuthenticator"

@using CRISP.Server.Components.Account
@using CRISP.Server.Data
@using Microsoft.AspNetCore.Identity

@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager
@inject IdentityUserAccessor UserAccessor
@inject IdentityRedirectManager RedirectManager
@inject ILogger<ResetAuthenticator> Logger

<PageTitle>Reset authenticator key</PageTitle>

<div class="space-y-6">
    <div>
        <h2 class="text-lg font-medium text-foreground">Reset authenticator</h2>
        <p class="text-sm text-muted-foreground">Reset your authenticator app configuration.</p>
    </div>
    
    <StatusMessage />
    
    <div class="rounded-lg border border-destructive/50 bg-destructive/10 p-4">
        <div class="flex">
            <svg class="h-5 w-5 text-destructive" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div class="ml-3">
                <p class="text-sm font-medium text-destructive">
                    Warning: This will disable your authenticator
                </p>
                <p class="mt-1 text-sm text-destructive/80">
                    If you reset your authenticator key, your authenticator app will not work until you reconfigure it. 
                    This process disables 2FA until you verify your authenticator app. If you do not complete the configuration, you may lose access to your account.
                </p>
            </div>
        </div>
    </div>
    
    <form @formname="reset-authenticator" @onsubmit="OnSubmitAsync" method="post">
        <AntiforgeryToken />
        <button type="submit"
            class="inline-flex items-center justify-center rounded-md bg-destructive px-4 py-2 text-sm font-medium text-destructive-foreground hover:bg-destructive/90 transition-colors">
            Reset authenticator key
        </button>
    </form>
</div>

@code {
    [CascadingParameter]
    private HttpContext HttpContext { get; set; } = default!;

    private async Task OnSubmitAsync()
    {
        var user = await UserAccessor.GetRequiredUserAsync(HttpContext);
        await UserManager.SetTwoFactorEnabledAsync(user, false);
        await UserManager.ResetAuthenticatorKeyAsync(user);
        var userId = await UserManager.GetUserIdAsync(user);
        Logger.LogInformation("User with ID '{UserId}' has reset their authentication app key.", userId);

        await SignInManager.RefreshSignInAsync(user);

        RedirectManager.RedirectToWithStatus(
            "Account/Manage/EnableAuthenticator",
            "Your authenticator app key has been reset. You will need to configure your authenticator app using the new key.",
            HttpContext);
    }
}
